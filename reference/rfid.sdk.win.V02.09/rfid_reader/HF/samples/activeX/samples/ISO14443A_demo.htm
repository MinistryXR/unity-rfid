<HTML>
<HEAD>
<TITLE>MyActiveX - Methods, Properties, and Events</TITLE>

<SCRIPT LANGUAGE="JavaScript">
var intervalid;


window.onload=function()
{
     var devCnt = MyActiveX1.RDR_GetLoadedReaderDriverCount();
	 var j=0;
     for(j=0;j<devCnt;j++)
     {
         var devName = MyActiveX1.RDR_GetLoadedReaderDriverOpt(j,"NAME");
         var varItem = new Option(devName, j);      
         DeviceType.options.add(varItem);      
     }

	 var ComNum = MyActiveX1.COMPort_Enum();
	 for(j=0;j<ComNum;j++)
	 {
	     var sComName = MyActiveX1.COMPort_GetEnumItem(j);
         var varItem = new Option(sComName, j);      
         ComName.options.add(varItem);    
	 }

	 BaudVal.selectedIndex = 1;
	 FramVal.selectedIndex = 0;
	 Open.disabled=false;
	 Close.disabled=true;
	 CardSerial.disabled=true;
	 Inventory.disabled=true;
	 CardType.disabled=true;
	 Connect.disabled=true;
     Disconnect.disabled=true;
     Block.disabled=true;
     KeyVal.disabled=true;
     KeyType.disabled=true;
     BlkData.disabled=true;
     MoneyVal.disabled=true;
     Authenticate.disabled=true;
     ReadBlockData.disabled=true;
     WriteBlockData.disabled=true;
     FormatValueBlock.disabled=true;
     Increment.disabled=true;
     Decrement.disabled=true;
     Restore.disabled=true;
	 OpenTypeChange();
}

function OpenTypeChange()
{
    var sOpenType = OpenType[OpenType.selectedIndex].text;
	if(sOpenType=="COM")
	{
	    ComName.disabled = false;
		BaudVal.disabled = false;
		FramVal.disabled = false;
		IPAddr.disabled = true;
		nPortVal.disabled = true;
	}
	else if(sOpenType=="NET")
	{
	    ComName.disabled = true;
		BaudVal.disabled = true;
		FramVal.disabled = true;
		IPAddr.disabled = false;
		nPortVal.disabled = false;
	}
	else if(sOpenType=="USB")
	{
	    ComName.disabled = true;
		BaudVal.disabled = true;
		FramVal.disabled = true;
		IPAddr.disabled = true;
		nPortVal.disabled = true;
	}
}


function OnOpen()
{
     var nret = -1;
	 var sOpenType = OpenType[OpenType.selectedIndex].text;
	 var sDevName = DeviceType[DeviceType.selectedIndex].text;
	 if(sOpenType=="COM")
	 {
	    var sComName = ComName[ComName.selectedIndex].text;
		var sBaud = BaudVal[BaudVal.selectedIndex].text;
		var sFrame = FramVal[FramVal.selectedIndex].text;
	 	nret = MyActiveX1.RDR_OpenPort(sDevName,sComName,sBaud,sFrame);
	 }
	 else if(sOpenType=="USB")
	 {
	    nret = MyActiveX1.RDR_OpenUSB(sDevName,0,"");
	 }
	 else if(sOpenType=="NET")
	 {
	     var sIp = IPAddr.value;
		 var nPort = nPortVal.value;
		 nret = MyActiveX1.RDR_OpenNet(sDevName,sIp,nPort);
	 }
	 if(nret==0)
	 {
	    DeviceType.disabled=true;
        OpenType.disabled=true;
        ComName.disabled=true;
        BaudVal.disabled=true;
        FramVal.disabled=true;
        IPAddr.disabled=true;
        nPortVal.disabled=true;
		Open.disabled=true;
	    Close.disabled=false;
		Inventory.disabled=false;
		CardSerial.disabled=false;
	 }
	 else
	 {
	    alert("打开设备失败!");
	 }
}

function OnClose()
{
     MyActiveX1.RDR_Close();
	 DeviceType.disabled=false;
     OpenType.disabled=false;
	 Open.disabled=false;
	 Close.disabled=true;
	 CardSerial.disabled=true;
	 Inventory.disabled=true;
	 CardType.disabled=true;
	 Connect.disabled=true;
     Disconnect.disabled=true;
     Block.disabled=true;
     KeyVal.disabled=true;
     KeyType.disabled=true;
     BlkData.disabled=true;
     MoneyVal.disabled=true;
     Authenticate.disabled=true;
     ReadBlockData.disabled=true;
     WriteBlockData.disabled=true;
     FormatValueBlock.disabled=true;
     Increment.disabled=true;
     Decrement.disabled=true;
     Restore.disabled=true;
	 CardSerial.options.length=0;
	 OpenTypeChange();

}

function OnInventory()
{	
    var nret=0;
	var recordCnt=0;
	var j=0;
	CardSerial.options.length=0
    nret = MyActiveX1.RDR_InitInventory();
	if(nret!=0)
	{
		return ;
	}
	nret = MyActiveX1.RDR_Enable14443A();
	if(nret!=0)
	{
	    MyActiveX1.RDR_FinishInventory();
		return;
	}
	nret = MyActiveX1.RDR_Inventory(0,"");
	if(nret!=0)
	{
	    MyActiveX1.RDR_FinishInventory();
		return;
	}
	recordCnt = MyActiveX1.RDR_GetRecordCnt();
	
	for(j=0;j<recordCnt;j++)
	{
	    var sTagInfo = MyActiveX1.GetRecord(j).split("-");
		var sTagID = sTagInfo[sTagInfo.length-1];
		var varItem = new Option(sTagID, j);      
        CardSerial.options.add(varItem); 
	}
	if(recordCnt>0)
	{
	    Connect.disabled=false;
		CardType.disabled=false;
		Disconnect.disabled=true;
		
	}
	else
	{
	    Connect.disabled=true;
		CardType.disabled=true;
		Disconnect.disabled=true;
	}
    MyActiveX1.RDR_FinishInventory();
}

function OnConnect()
{
   var nret=0;
   var cardType = CardType.value;
   var uids = CardSerial[CardSerial.selectedIndex].text;
   
   
   if(uids=="")
   {
      alert("卡号不能为空");
      return;
   }
   
   nret = MyActiveX1.MFCL_Connect(cardType,uids);
   
   if(nret==0)
   {
	    Connect.disabled=true;
		CardType.disabled=true;
		Disconnect.disabled=false;
		Block.disabled=false;
        KeyVal.disabled=false;
        KeyType.disabled=false;
        BlkData.disabled=false;
        MoneyVal.disabled=false;
        Authenticate.disabled=false;
        ReadBlockData.disabled=false;
        WriteBlockData.disabled=false;
        FormatValueBlock.disabled=false;
        Increment.disabled=false;
        Decrement.disabled=false;
        Restore.disabled=false;
   }

}

function OnDisconnect()
{
    var nret = MyActiveX1.RDR_TagDisconnect();
    if(nret==0)
    {
        Connect.disabled=false;
        Disconnect.disabled=true;
		Block.disabled=true;
        KeyVal.disabled=true;
        KeyType.disabled=true;
        BlkData.disabled=true;
        MoneyVal.disabled=true;
        Authenticate.disabled=true;
        ReadBlockData.disabled=true;
        WriteBlockData.disabled=true;
        FormatValueBlock.disabled=true;
        Increment.disabled=true;
        Decrement.disabled=true;
        Restore.disabled=true;
    }
}

function OnAuthenticate()
{
    var addr = parseInt(Block.value,10);
    var TypeofKey = KeyType.value; 
    var nret = MyActiveX1.MFCL_Authenticate(addr,TypeofKey,KeyVal.value);
    if(nret==0)
    {
        alert("认证成功");
    }
    else
    {
        alert("认证失败");
    }
}

function ReadBlock()
{
     var addr = parseInt(Block.value,10);
     var blkData="";
     var DataStr =MyActiveX1.MFCL_ReadBlock(addr);
     BlkData.value = DataStr;
     if(blkData == "") 
     {
     
	    alert("读数据成功!");
     }
     else 
     {
        alert("读数据失败!");
     }
}

function OnWriteBlock()
{
     var addr = parseInt(Block.value,10);
     var iret =MyActiveX1.MFCL_WriteBlock(addr,BlkData.value);   
     if(iret==0)
     {
        alert("写数据块成功");
     }
     else
     {
        alert("写数据块失败");
     }
}

function OnFormatValueBlock()
{
    var addr = parseInt(Block.value,10);
    var m_Money = parseInt(MoneyVal.value,10);
    var iret =MyActiveX1.MFCL_FormatValueBlock(addr,m_Money); 
    if(iret==0)
    {
        alert("格式化数值数据块成功");
    }
    else
    {
        alert("格式化数值数据块失败");
    }
}

function OnIncrement()
{
    var addr = parseInt(Block.value,10);
    var m_Money = parseInt(MoneyVal.value,10);
    var iret =MyActiveX1.MFCL_Increment(addr,m_Money); 
    if(iret==0)
    {
        alert("充值成功");
    }
    else
    {
        alert("充值失败");
    }
}

function OnDecrement()
{
    var addr = parseInt(Block.value,10);
    var m_Money = parseInt(MoneyVal.value,10);
    var iret =MyActiveX1.MFCL_Decrement(addr,m_Money); 
    if(iret==0)
    {
        alert("扣值成功");
    }
    else
    {
        alert("扣值失败");
    }
}


function OnRestore()
{
    var addr = parseInt(Block.value,10);
    var iret =MyActiveX1.MFCL_Restore(addr); 
    if(iret==0)
    {
        alert("备份金额成功");
    }
    else
    {
        alert("备份金额失败");
    }
}


</SCRIPT>

</HEAD>
<BODY>
<center style="font-weight: 700">

<p></p>
<OBJECT ID="MyActiveX1" WIDTH=0 HEIGHT=0
 CLASSID="CLSID:38BEF3F4-E284-4548-8E7B-FE20AE443AD8">
    <PARAM NAME="_Version" VALUE="65536">
    <PARAM NAME="_ExtentX" VALUE="2646">
    <PARAM NAME="_ExtentY" VALUE="1323">
    <PARAM NAME="_StockProps" VALUE="0">
</OBJECT>

<fieldset style="font: 9pt 宋体; width: 600px; height: 200"><legend>设备参数</legend>

    设备类型:<select name="DeviceType" style="width:75px"></select>
    端口类型:<select name="OpenType" style="width:75px"  onchange="OpenTypeChange();"><option value=0>COM</option><option value=1>USB</option><option value=2>NET</option></select>

    <p></p>
    <fieldset style="font: 9pt 宋体; width: 500px; height: 40"><legend>串口参数</legend>
       串口号:<select name="ComName" style="width:75px"></select>
       波特率:<select name="BaudVal" style="width:75px"><option value=0>9600</option><option value=1>38400</option><option value=2>115200</option></select>
       帧结构:<select name="FramVal" style="width:75px"><option value=0>8E1</option><option value=1>8N1</option><option value=2>8O1</option></select>
    </fieldset>

    <p></p>
    <fieldset style="font: 9pt 宋体; width: 500px; height: 40"><legend>网络参数</legend>
       IP地址:<INPUT TYPE ="text" NAME="IPAddr" VALUE="192.168.1.222 " size=50 style="width: 110px; height: 20px">
       端口号:<INPUT TYPE ="text" NAME="nPortVal" VALUE="9909" size=50 style="width: 40px; height: 20px">
    </fieldset>

    <p></p>
    <INPUT TYPE="button" NAME="Open" style="width:100px;" VALUE="打开"   ONCLICK=OnOpen()>
    <INPUT TYPE="button" NAME="Close" style="width:100px;" VALUE="关闭" ONCLICK=OnClose()>
</fieldset>

<p></p>
<fieldset style="font: 9pt 宋体; width: 600px;"><legend>S50/S70标签操作</legend>
    卡号: <select name="CardSerial" style="width:200px"></select>
    <INPUT TYPE="button" NAME="Inventory" VALUE="盘点" ONCLICK=OnInventory()>
  
    <p></p>    
    卡类型:<select name="CardType" style="width:70px;"><option value=0>S50</option><option value=1>S70</option></select>
    <INPUT TYPE="button" NAME="Connect" VALUE="连接" ONCLICK=OnConnect()>
    <INPUT TYPE="button" NAME="Disconnect" VALUE="断开" ONCLICK=OnDisconnect()>
    <p></p>

    块:<INPUT TYPE ="text" NAME="Block" style="width:50px;" VALUE="0">
    密钥:<INPUT TYPE ="text" NAME="KeyVal" VALUE="FFFFFFFFFFFF">
    密钥类型:<select name="KeyType" style="width:75px;"><option value=0>Key A</option><option value=1>Key B</option></select>
    <p></p>
    读写数据: <INPUT TYPE ="text" NAME="BlkData" VALUE="FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF" size=50 style="width: 276px; height: 20px">

    <p></p>
    金额:<INPUT TYPE ="text" NAME="MoneyVal" VALUE="0">
    <p></p>
    <INPUT TYPE="button" NAME="Authenticate" VALUE="认证" ONCLICK=OnAuthenticate()>
    <INPUT TYPE="button" NAME="ReadBlockData" VALUE="读数据块" ONCLICK=ReadBlock()>
    <INPUT TYPE="button" NAME="WriteBlockData" VALUE="写数据块" ONCLICK=OnWriteBlock()>
    <INPUT TYPE="button" NAME="FormatValueBlock" VALUE="格式化数值数据块" ONCLICK=OnFormatValueBlock()>
    <INPUT TYPE="button" NAME="Increment" VALUE="充值" ONCLICK=OnIncrement()>
    <INPUT TYPE="button" NAME="Decrement" VALUE="扣值" ONCLICK=OnDecrement()>
    <INPUT TYPE="button" NAME="Restore" VALUE="备份金额" ONCLICK=OnRestore()>
</fieldset>


</center>
</BODY>
</HTML>